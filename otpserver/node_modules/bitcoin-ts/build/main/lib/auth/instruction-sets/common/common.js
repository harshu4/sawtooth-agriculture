"use strict";
function __export(m) {
    for (var p in m) if (!exports.hasOwnProperty(p)) exports[p] = m[p];
}
Object.defineProperty(exports, "__esModule", { value: true });
const transaction_1 = require("../../../transaction");
const arithmetic_1 = require("./arithmetic");
const bitwise_1 = require("./bitwise");
const combinators_1 = require("./combinators");
const crypto_1 = require("./crypto");
const errors_1 = require("./errors");
const flow_control_1 = require("./flow-control");
const nop_1 = require("./nop");
const opcodes_1 = require("./opcodes");
const push_1 = require("./push");
const splice_1 = require("./splice");
const stack_1 = require("./stack");
const time_1 = require("./time");
__export(require("./arithmetic"));
__export(require("./bitwise"));
__export(require("./combinators"));
__export(require("./crypto"));
__export(require("./descriptions"));
__export(require("./encoding"));
__export(require("./errors"));
__export(require("./flow-control"));
__export(require("./nop"));
__export(require("./opcodes"));
__export(require("./push"));
__export(require("./signing-serialization"));
__export(require("./splice"));
__export(require("./stack"));
__export(require("./time"));
__export(require("./types"));
var ConsensusCommon;
(function (ConsensusCommon) {
    /**
     * A.K.A. `MAX_SCRIPT_ELEMENT_SIZE`
     */
    ConsensusCommon[ConsensusCommon["maximumStackItemLength"] = 520] = "maximumStackItemLength";
    ConsensusCommon[ConsensusCommon["maximumScriptNumberLength"] = 4] = "maximumScriptNumberLength";
    /**
     * A.K.A. `MAX_OPS_PER_SCRIPT`
     */
    ConsensusCommon[ConsensusCommon["maximumOperationCount"] = 201] = "maximumOperationCount";
    /**
     * A.K.A. `MAX_SCRIPT_SIZE`
     */
    ConsensusCommon[ConsensusCommon["maximumBytecodeLength"] = 10000] = "maximumBytecodeLength";
    /**
     * A.K.A. `MAX_STACK_SIZE`
     */
    ConsensusCommon[ConsensusCommon["maximumStackDepth"] = 1000] = "maximumStackDepth";
})(ConsensusCommon = exports.ConsensusCommon || (exports.ConsensusCommon = {}));
exports.undefinedOperation = () => ({
    undefined: combinators_1.conditionallyEvaluate((state) => errors_1.applyError(errors_1.AuthenticationErrorCommon.unknownOpcode, state))
});
exports.checkLimitsCommon = (operation) => (state) => {
    const nextState = operation(state);
    return nextState.stack.length + nextState.alternateStack.length >
        ConsensusCommon.maximumStackDepth
        ? errors_1.applyError(errors_1.AuthenticationErrorCommon.exceededMaximumStackDepth, nextState)
        : nextState.operationCount > ConsensusCommon.maximumOperationCount
            ? errors_1.applyError(errors_1.AuthenticationErrorCommon.exceededMaximumOperationCount, nextState)
            : nextState;
};
exports.commonOperations = (sha1, sha256, ripemd160, secp256k1, flags) => {
    const unconditionalOperations = Object.assign(Object.assign(Object.assign({}, nop_1.disabledOperations()), push_1.pushOperations(flags)), combinators_1.mapOverOperations(flow_control_1.unconditionalFlowControlOperations(flags), combinators_1.incrementOperationCount));
    const conditionalOperations = combinators_1.mapOverOperations(Object.assign(Object.assign({}, push_1.pushNumberOperations()), { [opcodes_1.OpcodesCommon.OP_RESERVED]: flow_control_1.reservedOperation() }), combinators_1.conditionallyEvaluate);
    const incrementingOperations = combinators_1.mapOverOperations(Object.assign(Object.assign(Object.assign(Object.assign(Object.assign(Object.assign(Object.assign(Object.assign({}, arithmetic_1.arithmeticOperations(flags)), bitwise_1.bitwiseOperations()), crypto_1.cryptoOperations(sha1, sha256, ripemd160, secp256k1, flags)), flow_control_1.conditionalFlowControlOperations()), stack_1.stackOperations(flags)), splice_1.spliceOperations()), time_1.timeOperations(flags)), nop_1.nonOperations(flags)), combinators_1.conditionallyEvaluate, combinators_1.incrementOperationCount);
    return combinators_1.mapOverOperations(Object.assign(Object.assign(Object.assign({}, unconditionalOperations), incrementingOperations), conditionalOperations), exports.checkLimitsCommon);
};
exports.cloneStack = (stack) => stack.reduce((newStack, element) => {
    // eslint-disable-next-line functional/no-expression-statement, functional/immutable-data
    newStack.push(element.slice());
    return newStack;
}, []);
exports.createAuthenticationProgramInternalStateCommon = (instructions, stack = []) => ({
    alternateStack: [],
    executionStack: [],
    instructions,
    ip: 0,
    lastCodeSeparator: -1,
    operationCount: 0,
    signatureOperationsCount: 0,
    stack
});
exports.createAuthenticationProgramExternalStateCommon = (program) => ({
    correspondingOutput: program.inputIndex < program.spendingTransaction.outputs.length
        ? transaction_1.serializeOutput(program.spendingTransaction.outputs[program.inputIndex])
        : undefined,
    locktime: program.spendingTransaction.locktime,
    outpointIndex: program.spendingTransaction.inputs[program.inputIndex].outpointIndex,
    outpointTransactionHash: program.spendingTransaction.inputs[program.inputIndex]
        .outpointTransactionHash,
    outputValue: program.sourceOutput.satoshis,
    sequenceNumber: program.spendingTransaction.inputs[program.inputIndex].sequenceNumber,
    transactionOutpoints: transaction_1.serializeOutpoints(program.spendingTransaction.inputs),
    transactionOutputs: transaction_1.serializeOutputsForSigning(program.spendingTransaction.outputs),
    transactionSequenceNumbers: transaction_1.serializeSequenceNumbers(program.spendingTransaction.inputs),
    version: program.spendingTransaction.version
});
exports.createAuthenticationProgramStateCommon = (instructions, stack, externalState) => (Object.assign(Object.assign({}, exports.createAuthenticationProgramInternalStateCommon(instructions, stack)), externalState));
exports.cloneAuthenticationProgramStateCommon = (state) => (Object.assign(Object.assign({}, (state.error === undefined ? {} : { error: state.error })), { alternateStack: state.alternateStack.slice(), correspondingOutput: state.correspondingOutput, executionStack: state.executionStack.slice(), instructions: state.instructions.slice(), ip: state.ip, lastCodeSeparator: state.lastCodeSeparator, locktime: state.locktime, operationCount: state.operationCount, outpointIndex: state.outpointIndex, outpointTransactionHash: state.outpointTransactionHash.slice(), outputValue: state.outputValue, sequenceNumber: state.sequenceNumber, signatureOperationsCount: state.signatureOperationsCount, stack: state.stack.slice(), transactionOutpoints: state.transactionOutpoints, transactionOutputs: state.transactionOutputs, transactionSequenceNumbers: state.transactionSequenceNumbers, version: state.version }));
/**
 * This is a meaningless but complete `CommonExternalProgramState`, useful for
 * testing and debugging.
 */
exports.createAuthenticationProgramExternalStateCommonEmpty = () => ({
    correspondingOutput: Uint8Array.of(1 /* correspondingOutput */),
    locktime: 0,
    outpointIndex: 0,
    outpointTransactionHash: new Uint8Array(32 /* length */).fill(5 /* outpointTransactionHash */),
    outputValue: BigInt(0),
    sequenceNumber: 0,
    transactionOutpoints: Uint8Array.of(2 /* transactionOutpoints */),
    transactionOutputs: Uint8Array.of(3 /* transactionOutputs */),
    transactionSequenceNumbers: Uint8Array.of(4 /* transactionSequenceNumbers */),
    version: 0
});
/**
 * Create an "empty" CommonProgramState, suitable for testing a VM/compiler.
 */
exports.createAuthenticationProgramStateCommonEmpty = (instructions, stack = []) => (Object.assign(Object.assign({}, exports.createAuthenticationProgramInternalStateCommon(instructions, stack)), exports.createAuthenticationProgramExternalStateCommonEmpty()));
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29tbW9uLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vc3JjL2xpYi9hdXRoL2luc3RydWN0aW9uLXNldHMvY29tbW9uL2NvbW1vbi50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7OztBQUFBLHNEQUs4QjtBQWM5Qiw2Q0FBb0Q7QUFDcEQsdUNBQThDO0FBQzlDLCtDQUl1QjtBQUN2QixxQ0FBZ0Y7QUFDaEYscUNBQWlFO0FBQ2pFLGlEQUl3QjtBQUN4QiwrQkFBMEQ7QUFDMUQsdUNBQTBDO0FBQzFDLGlDQUE4RDtBQUM5RCxxQ0FBNEM7QUFDNUMsbUNBQTBDO0FBQzFDLGlDQUF3QztBQUV4QyxrQ0FBNkI7QUFDN0IsK0JBQTBCO0FBQzFCLG1DQUE4QjtBQUM5Qiw4QkFBeUI7QUFDekIsb0NBQStCO0FBQy9CLGdDQUEyQjtBQUMzQiw4QkFBeUI7QUFDekIsb0NBQStCO0FBQy9CLDJCQUFzQjtBQUN0QiwrQkFBMEI7QUFDMUIsNEJBQXVCO0FBQ3ZCLDZDQUF3QztBQUN4Qyw4QkFBeUI7QUFDekIsNkJBQXdCO0FBQ3hCLDRCQUF1QjtBQUN2Qiw2QkFBd0I7QUFFeEIsSUFBWSxlQWtCWDtBQWxCRCxXQUFZLGVBQWU7SUFDekI7O09BRUc7SUFDSCwyRkFBNEIsQ0FBQTtJQUM1QiwrRkFBNkIsQ0FBQTtJQUM3Qjs7T0FFRztJQUNILHlGQUEyQixDQUFBO0lBQzNCOztPQUVHO0lBQ0gsMkZBQTZCLENBQUE7SUFDN0I7O09BRUc7SUFDSCxrRkFBd0IsQ0FBQTtBQUMxQixDQUFDLEVBbEJXLGVBQWUsR0FBZix1QkFBZSxLQUFmLHVCQUFlLFFBa0IxQjtBQUVZLFFBQUEsa0JBQWtCLEdBQUcsR0FHOUIsRUFBRSxDQUFDLENBQUM7SUFDTixTQUFTLEVBQUUsbUNBQXFCLENBQUMsQ0FBQyxLQUFZLEVBQUUsRUFBRSxDQUNoRCxtQkFBVSxDQUFnQixrQ0FBeUIsQ0FBQyxhQUFhLEVBQUUsS0FBSyxDQUFDLENBQzFFO0NBQ0Ys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