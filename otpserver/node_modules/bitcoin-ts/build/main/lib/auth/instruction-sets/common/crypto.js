"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const bch_types_1 = require("../bch/bch-types");
const instruction_sets_utils_1 = require("../instruction-sets-utils");
const combinators_1 = require("./combinators");
const common_1 = require("./common");
const encoding_1 = require("./encoding");
const errors_1 = require("./errors");
const flow_control_1 = require("./flow-control");
const opcodes_1 = require("./opcodes");
const signing_serialization_1 = require("./signing-serialization");
exports.opRipemd160 = (ripemd160) => (state) => combinators_1.useOneStackItem(state, (nextState, value) => combinators_1.pushToStack(nextState, ripemd160.hash(value)));
exports.opSha1 = (sha1) => (state) => combinators_1.useOneStackItem(state, (nextState, value) => combinators_1.pushToStack(nextState, sha1.hash(value)));
exports.opSha256 = (sha256) => (state) => combinators_1.useOneStackItem(state, (nextState, value) => combinators_1.pushToStack(nextState, sha256.hash(value)));
exports.opHash160 = (sha256, ripemd160) => (state) => combinators_1.useOneStackItem(state, (nextState, value) => combinators_1.pushToStack(nextState, ripemd160.hash(sha256.hash(value))));
exports.opHash256 = (sha256) => (state) => combinators_1.useOneStackItem(state, (nextState, value) => combinators_1.pushToStack(nextState, sha256.hash(sha256.hash(value))));
exports.opCodeSeparator = () => (state) => {
    // eslint-disable-next-line functional/no-expression-statement, functional/immutable-data
    state.lastCodeSeparator = state.ip;
    return state;
};
exports.opCheckSig = (sha256, secp256k1, flags) => (s) => 
// eslint-disable-next-line complexity
combinators_1.useTwoStackItems(s, (state, bitcoinEncodedSignature, publicKey) => {
    if (!encoding_1.isValidPublicKeyEncoding(publicKey)) {
        return errors_1.applyError(errors_1.AuthenticationErrorCommon.invalidPublicKeyEncoding, state);
    }
    if (!encoding_1.isValidSignatureEncodingBCHTransaction(bitcoinEncodedSignature)) {
        return errors_1.applyError(errors_1.AuthenticationErrorCommon.invalidSignatureEncoding, state);
    }
    const coveredBytecode = instruction_sets_utils_1.serializeAuthenticationInstructions(state.instructions).subarray(state.lastCodeSeparator + 1);
    const { signingSerializationType, signature } = encoding_1.decodeBitcoinSignature(bitcoinEncodedSignature);
    const serialization = signing_serialization_1.generateSigningSerializationBCH(sha256, state.version, state.transactionOutpoints, state.transactionSequenceNumbers, state.outpointTransactionHash, state.outpointIndex, coveredBytecode, state.outputValue, state.sequenceNumber, state.correspondingOutput, state.transactionOutputs, state.locktime, signingSerializationType);
    const digest = sha256.hash(sha256.hash(serialization));
    const useSchnorr = signature.length === bch_types_1.ConsensusBCH.schnorrSignatureLength;
    const success = useSchnorr
        ? secp256k1.verifySignatureSchnorr(signature, publicKey, digest)
        : secp256k1.verifySignatureDERLowS(signature, publicKey, digest);
    return !success &&
        flags.requireNullSignatureFailures &&
        signature.length !== 0
        ? errors_1.applyError(errors_1.AuthenticationErrorCommon.nonNullSignatureFailure, state)
        : combinators_1.pushToStack(state, common_1.booleanToScriptNumber(success));
});
exports.opCheckMultiSig = (sha256, secp256k1, flags) => (s) => combinators_1.useOneScriptNumber(s, (state, publicKeysValue) => {
    const potentialPublicKeys = Number(publicKeysValue);
    if (potentialPublicKeys < 0) {
        return errors_1.applyError(errors_1.AuthenticationErrorCommon.invalidNaturalNumber, state);
    }
    if (potentialPublicKeys > 20 /* maximumPublicKeys */) {
        return errors_1.applyError(errors_1.AuthenticationErrorCommon.exceedsMaximumMultisigPublicKeyCount, state);
    }
    const publicKeys = 
    // eslint-disable-next-line functional/immutable-data
    potentialPublicKeys > 0 ? state.stack.splice(-potentialPublicKeys) : [];
    // eslint-disable-next-line functional/no-expression-statement, functional/immutable-data
    state.operationCount += potentialPublicKeys;
    return state.operationCount > common_1.ConsensusCommon.maximumOperationCount
        ? errors_1.applyError(errors_1.AuthenticationErrorCommon.exceededMaximumOperationCount, state)
        : combinators_1.useOneScriptNumber(state, (nextState, approvingKeys) => {
            const requiredApprovingPublicKeys = Number(approvingKeys);
            if (requiredApprovingPublicKeys < 0) {
                return errors_1.applyError(errors_1.AuthenticationErrorCommon.invalidNaturalNumber, nextState);
            }
            if (requiredApprovingPublicKeys > potentialPublicKeys) {
                return errors_1.applyError(errors_1.AuthenticationErrorCommon.insufficientPublicKeys, nextState);
            }
            const signatures = requiredApprovingPublicKeys > 0
                ? // eslint-disable-next-line functional/immutable-data
                    nextState.stack.splice(-requiredApprovingPublicKeys)
                : [];
            return combinators_1.useOneStackItem(nextState, 
            // eslint-disable-next-line complexity
            (finalState, protocolBugValue) => {
                if (flags.requireBugValueZero &&
                    protocolBugValue.length !== 0) {
                    return errors_1.applyError(errors_1.AuthenticationErrorCommon.invalidProtocolBugValue, finalState);
                }
                const coveredBytecode = instruction_sets_utils_1.serializeAuthenticationInstructions(finalState.instructions).subarray(finalState.lastCodeSeparator + 1);
                let approvingPublicKeys = 0; // eslint-disable-line functional/no-let
                let remainingSignatures = signatures.length; // eslint-disable-line functional/no-let
                let remainingPublicKeys = publicKeys.length; // eslint-disable-line functional/no-let
                // eslint-disable-next-line functional/no-loop-statement
                while (remainingSignatures > 0 &&
                    remainingPublicKeys > 0 &&
                    approvingPublicKeys + remainingPublicKeys >=
                        remainingSignatures &&
                    approvingPublicKeys !== requiredApprovingPublicKeys) {
                    const publicKey = publicKeys[remainingPublicKeys - 1];
                    const bitcoinEncodedSignature = signatures[remainingSignatures - 1];
                    if (!encoding_1.isValidPublicKeyEncoding(publicKey)) {
                        return errors_1.applyError(errors_1.AuthenticationErrorCommon.invalidPublicKeyEncoding, finalState);
                    }
                    if (!encoding_1.isValidSignatureEncodingBCHTransaction(bitcoinEncodedSignature)) {
                        return errors_1.applyError(errors_1.AuthenticationErrorCommon.invalidSignatureEncoding, finalState);
                    }
                    const { signingSerializationType, signature } = encoding_1.decodeBitcoinSignature(bitcoinEncodedSignature);
                    const serialization = signing_serialization_1.generateSigningSerializationBCH(sha256, finalState.version, finalState.transactionOutpoints, finalState.transactionSequenceNumbers, finalState.outpointTransactionHash, finalState.outpointIndex, coveredBytecode, finalState.outputValue, finalState.sequenceNumber, finalState.correspondingOutput, finalState.transactionOutputs, finalState.locktime, signingSerializationType);
                    const digest = sha256.hash(sha256.hash(serialization));
                    if (signature.length === bch_types_1.ConsensusBCH.schnorrSignatureLength) {
                        return errors_1.applyError(errors_1.AuthenticationErrorCommon.schnorrSizedSignatureInCheckMultiSig, finalState);
                    }
                    const signed = secp256k1.verifySignatureDERLowS(signature, publicKey, digest);
                    // eslint-disable-next-line functional/no-conditional-statement
                    if (signed) {
                        approvingPublicKeys += 1; // eslint-disable-line functional/no-expression-statement
                        remainingSignatures -= 1; // eslint-disable-line functional/no-expression-statement
                    }
                    remainingPublicKeys -= 1; // eslint-disable-line functional/no-expression-statement
                }
                const success = approvingPublicKeys === requiredApprovingPublicKeys;
                if (!success &&
                    flags.requireNullSignatureFailures &&
                    !signatures.every(signature => signature.length === 0)) {
                    return errors_1.applyError(errors_1.AuthenticationErrorCommon.nonNullSignatureFailure, finalState);
                }
                return combinators_1.pushToStack(finalState, common_1.booleanToScriptNumber(success));
            });
        }, flags.requireMinimalEncoding);
}, flags.requireMinimalEncoding);
exports.opCheckSigVerify = (sha256, secp256k1, flags) => combinators_1.combineOperations(exports.opCheckSig(sha256, secp256k1, flags), flow_control_1.opVerify());
exports.opCheckMultiSigVerify = (sha256, secp256k1, flags) => combinators_1.combineOperations(exports.opCheckMultiSig(sha256, secp256k1, flags), flow_control_1.opVerify());
exports.cryptoOperations = (sha1, sha256, ripemd160, secp256k1, flags) => ({
    [opcodes_1.OpcodesCommon.OP_RIPEMD160]: exports.opRipemd160(ripemd160),
    [opcodes_1.OpcodesCommon.OP_SHA1]: exports.opSha1(sha1),
    [opcodes_1.OpcodesCommon.OP_SHA256]: exports.opSha256(sha256),
    [opcodes_1.OpcodesCommon.OP_HASH160]: exports.opHash160(sha256, ripemd160),
    [opcodes_1.OpcodesCommon.OP_HASH256]: exports.opHash256(sha256),
    [opcodes_1.OpcodesCommon.OP_CODESEPARATOR]: exports.opCodeSeparator(),
    [opcodes_1.OpcodesCommon.OP_CHECKSIG]: exports.opCheckSig(sha256, secp256k1, flags),
    [opcodes_1.OpcodesCommon.OP_CHECKSIGVERIFY]: exports.opCheckSigVerify(sha256, secp256k1, flags),
    [opcodes_1.OpcodesCommon.OP_CHECKMULTISIG]: exports.opCheckMultiSig(sha256, secp256k1, flags),
    [opcodes_1.OpcodesCommon.OP_CHECKMULTISIGVERIFY]: exports.opCheckMultiSigVerify(sha256, secp256k1, flags)
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY3J5cHRvLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vc3JjL2xpYi9hdXRoL2luc3RydWN0aW9uLXNldHMvY29tbW9uL2NyeXB0by50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQVFBLGdEQUFnRDtBQUNoRCxzRUFBZ0Y7QUFFaEYsK0NBTXVCO0FBQ3ZCLHFDQUFrRTtBQUNsRSx5Q0FJb0I7QUFDcEIscUNBQWlFO0FBQ2pFLGlEQUEwQztBQUMxQyx1Q0FBMEM7QUFDMUMsbUVBQTBFO0FBSTdELFFBQUEsV0FBVyxHQUFHLENBS3pCLFNBQW9CLEVBQ0YsRUFBRSxDQUFDLENBQUMsS0FBWSxFQUFFLEVBQUUsQ0FDdEMsNkJBQWUsQ0FBQyxLQUFLLEVBQUUsQ0FBQyxTQUFTLEVBQUUsS0FBSyxFQUFFLEVBQUUsQ0FDMUMseUJBQVcsQ0FBQyxTQUFTLEVBQUUsU0FBUyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUM5QyxDQUFDO0FBRVMsUUFBQSxNQUFNLEdBQUcsQ0FLcEIsSUFBVSxFQUNRLEVBQUUsQ0FBQyxDQUFDLEtBQVksRUFBRSxFQUFFLENBQ3RDLDZCQUFlLENBQUMsS0FBSyxFQUFFLENBQUMsU0FBUyxFQUFFLEtBQUssRUFBRSxFQUFFLENBQzFDLHlCQUFXLENBQUMsU0FBUyxFQUFFLElBQUksQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FDekMsQ0FBQztBQUVTLFFBQUEsUUFBUSxHQUFHLENBS3RCLE1BQWMsRUFDSSxFQUFFLENBQUMsQ0FBQyxLQUFZLEVBQUUsRUFBRSxDQUN0Qyw2QkFBZSxDQUFDLEtBQUssRUFBRSxDQUFDLFNBQVMsRUFBRSxLQUFLLEVBQUUsRUFBRSxDQUMxQyx5QkFBVyxDQUFDLFNBQVMsRUFBRSxNQUFNLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQzNDLENBQUM7QUFFUyxRQUFBLFNBQVMsR0FBRyxDQUt2QixNQUFjLEVBQ2QsU0FBb0Is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